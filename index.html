<!doctype html>

<link rel="stylesheet" href="https://build.origami.ft.com/v2/bundles/css?modules=o-fonts@^2.1.3" />

<style>
* { box-sizing: border-box; }

body {
	background: #fff1e0;
}

x-timeline {
	max-width: 650px;
	margin: 0 auto;
}
</style>

<x-timeline>
	<x-timeline-item slot="item">
		<div slot="title">Lorem ipsum</div>
		Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean nec facilisis turpis. Aenean facilisis ex nec turpis tempus, a varius libero consectetur. Cras eu cursus odio. Fusce at nulla a metus placerat vehicula. Aenean semper libero tempus dignissim tempus. Praesent varius maximus tellus, ac dictum purus tempor id. Aliquam ultrices nec tortor non laoreet. Phasellus tincidunt eget nisi vitae molestie. Etiam sit amet vestibulum justo. Praesent ac tincidunt odio, quis egestas mauris. Proin augue augue, auctor id ultrices eu, accumsan a neque.
	</x-timeline-item>

	<x-timeline-item slot="item">
		<div slot="title">Lorem ipsum</div>
		Dolor sit amet, conseceteur adipiscing elit.
	</x-timeline-item>

	<x-timeline-item slot="item">
		<div slot="title">Lorem ipsum</div>
		Dolor sit amet, conseceteur adipiscing elit.
	</x-timeline-item>

	<x-timeline-item slot="item">
		<div slot="title">Lorem ipsum</div>
		Fusce mi nisl, euismod ac erat vitae, semper pharetra eros. Aenean ac lacinia erat, vitae sollicitudin mauris. Proin pellentesque ligula sit amet turpis gravida, et auctor est ornare. Nullam consequat lectus vitae interdum ultricies. Aliquam ut justo eleifend lacus convallis bibendum vitae non nulla. Fusce vel fringilla odio. Aliquam tincidunt risus eu est facilisis, sit amet dictum ante blandit. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Sed commodo egestas magna, a tempor justo tristique sit amet.
	</x-timeline-item>

	<x-timeline-item slot="item">
		<div slot="title">Lorem ipsum</div>
		Dolor sit amet, conseceteur adipiscing elit.
	</x-timeline-item>

	<x-timeline-item slot="item">
		<div slot="title">Lorem ipsum</div>
		Dolor sit amet, conseceteur adipiscing elit.
	</x-timeline-item>
		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean nec facilisis turpis. Aenean facilisis ex nec turpis tempus, a varius libero consectetur. Cras eu cursus odio. Fusce at nulla a metus placerat vehicula. Aenean semper libero tempus dignissim tempus. Praesent varius maximus tellus, ac dictum purus tempor id. Aliquam ultrices nec tortor non laoreet. Phasellus tincidunt eget nisi vitae molestie. Etiam sit amet vestibulum justo. Praesent ac tincidunt odio, quis egestas mauris. Proin augue augue, auctor id ultrices eu, accumsan a neque.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Dolor sit amet, conseceteur adipiscing elit.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Dolor sit amet, conseceteur adipiscing elit.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Dolor sit amet, conseceteur adipiscing elit.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Dolor sit amet, conseceteur adipiscing elit.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Dolor sit amet, conseceteur adipiscing elit.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Dolor sit amet, conseceteur adipiscing elit.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Fusce mi nisl, euismod ac erat vitae, semper pharetra eros. Aenean ac lacinia erat, vitae sollicitudin mauris. Proin pellentesque ligula sit amet turpis gravida, et auctor est ornare. Nullam consequat lectus vitae interdum ultricies. Aliquam ut justo eleifend lacus convallis bibendum vitae non nulla. Fusce vel fringilla odio. Aliquam tincidunt risus eu est facilisis, sit amet dictum ante blandit. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Sed commodo egestas magna, a tempor justo tristique sit amet.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Dolor sit amet, conseceteur adipiscing elit.
		</x-timeline-item>

		<x-timeline-item slot="item">
			<div slot="title">Lorem ipsum</div>
			Dolor sit amet, conseceteur adipiscing elit.
		</x-timeline-item>

</x-timeline>

<template id="timeline-template">
	<style>
		* { box-sizing: border-box; }

		:root {
			--height: auto;
		}

		:host {
			position: relative;
			display: block;
			padding-top: 1em;
		}

		#line {
			position: absolute;
			top: 0;
			bottom: 0;
			border-left: 1px dotted #d66d06;
		}

		@media (min-width: 650px) {
			:host {
				height: var(--height);
			}

			#line {
				left: 50%;
			}
		}
	</style>

	<div id="line"></div>
	<slot name="item"></slot>
</template>

<template id="timeline-item-template">
	<style>
		* { box-sizing: border-box; }

		:root {
			--position: 0;
		}

		:host {
			position: relative;
			display: block;
			border-top: 1px solid #d66d06;
			padding: 1em 1em 0;
			margin-bottom: 1em;
		}

		#blob {
			width: 9px;
			height: 9px;
			border-radius: 50%;
			position: absolute;
			background: #fff1e0;
			border: 1px solid #d66d06;
			top: -5px;
			left: -4px;
		}

		h1 {
			display: inline-block;
			position: relative;
			font-family: FinancierDisplayWeb;
			font-weight: normal;
			font-size: 1.6em;
			top: -1.9rem;
			margin: 0;
			background: #fff1e0;
			padding: 0 1rem;
		}

		#content {
			margin-top: -1.9rem;
			padding: 1rem 0;
			display: block;
			font-family: MetricWeb;
		}

		@media (min-width: 650px) {
			:host {
				transform: translateY(var(--position));
				left: 50%;
				width: 50%;
			}

			:host([data-side=left]) {
				text-align: right;
				left: 0;
				right: 50%;
			}

			:host([data-side=left]) #blob {
				left: auto;
				right: -5px;
			}
		}
	</style>

	<div id="blob"></div>

	<h1><slot name="title"></slot></h1>
	<div id="content"><slot></slot></div>
</template>

<script>
const sixFifty = matchMedia('(min-width: 650px)');

customElements.define('x-timeline', class Timeline extends HTMLElement {
	constructor() {
		super();
		this.attachShadow({mode: 'open'});
		const template = document.getElementById('timeline-template');
		this.shadowRoot.appendChild(template.content.cloneNode(true));
		this.alignIfTwoColumn = this.alignIfTwoColumn.bind(this);
	}

	alignIfTwoColumn({matches}) {
		if(matches) {
			this.alignItems();
		}
	}

	connectedCallback() {
		sixFifty.addEventListener('change', this.alignIfTwoColumn);
		requestAnimationFrame(() => {
			this.alignIfTwoColumn(sixFifty);
		});
	}

	disconnectedCallback() {
		sixFifty.removeListener('change', this.alignIfTwoColumn);
	}

	alignItems() {
		const slot = this.shadowRoot.querySelector('slot[name=item]');
		const items = slot.assignedNodes();

		const {lastPosition, origHeight} = items.reduce(
			({leftHeight, rightHeight, origHeight, lastPosition}, item) => {
				const {height: itemHeight} = item.getBoundingClientRect();
				const side = leftHeight > rightHeight ? 'right' : 'left';
				const nextHeight = Math.max(Math.min(
					leftHeight,
					rightHeight
				), lastPosition + 40);
				const position = nextHeight - origHeight;

				item.dataset.side = side;
				item.dataset.position = position;

				return {
					origHeight: origHeight + itemHeight,
					rightHeight: side === 'right' ? nextHeight + itemHeight : rightHeight,
					leftHeight: side === 'left' ? nextHeight + itemHeight : leftHeight,
					lastPosition: nextHeight,
				}
			},
			{leftHeight: 0, rightHeight: 0, origHeight: 0, lastPosition: -40}
		);

		this.style.setProperty('--height', `${origHeight - lastPosition}px`);
	}
});

customElements.define('x-timeline-item', class TimelineItem extends HTMLElement {
	static get observedAttributes() {
		return ['data-position'];
	}

	constructor() {
		super();
		this.attachShadow({mode: 'open'});
		const template = document.getElementById('timeline-item-template');
		this.shadowRoot.appendChild(template.content.cloneNode(true));
		this.style = this.shadowRoot.querySelector('style');
	}

	attributeChangedCallback(attr, old, val) {
		if(attr === 'data-position') {
			this.style.setProperty('--position', `${val}px`);
		}
	}
});
</script>
